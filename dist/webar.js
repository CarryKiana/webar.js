!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.WebAR=t()}(this,function(){"use strict";var e="DetectorResult",t="ARSessionDidInit";var n="FRONT",r="BACK",i="LOW",a="COVER",o="FaceDetector",u="MarkerDetector",s="LOW",c="MEDIUM",f="HIGH";var h=/\(i[^;]+;( U;)? CPU.+Mac OS X/.test(navigator.userAgent),l=!h;var m=require("gl-mat3");function d(e){return e.rotate=function(t){return m.rotate(e,e,t)},e.scale=function(t,n){return m.scale(e,e,[t,n])},e.translate=function(t,n){return m.translate(e,e,[t,n])},e}var v=function(e){if(!e)return d(m.create());if(e&&9!==e.length)throw new TypeError("Expected 9 Elements For Matrix");return d(new Float32Array(e))},T=0,g=1,p=2,R=3,E=4,y=5;function A(e){return e instanceof ArrayBuffer?new Uint8Array(e):e}var S=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},w=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),x=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e},_=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},b=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},D=function(){function e(t,n,r){var i=r.cameraPosition,a=r.cameraSize,o=r.orientation;S(this,e),this.gl=t,this.orientation=h?o:-o,this.cameraPosition=i,this.cameraSize=a,this.vertexShader=C(t,t.VERTEX_SHADER,n.vshader),this.fragmentShader=C(t,t.FRAGMENT_SHADER,n.fshader),this.program=function(e,t,n){var r=e.createProgram();if(e.attachShader(r,t),e.attachShader(r,n),e.linkProgram(r),e.getProgramParameter(r,e.LINK_STATUS))return r;var i=e.getProgramInfoLog(r);throw e.deleteProgram(r),new Error(i)}(t,this.vertexShader,this.fragmentShader),this.samplers=[],this.plugins=[],this.texCoordTranslate=[0,0],t.useProgram(this.program)}return w(e,[{key:"setupSamplers",value:function(e){var t=this,n=function(e){switch(e){case T:case g:break;case p:return["uYTex","uUTex","uVTex"].map(function(e){return{name:e,format:"LUMINANCE"}});case R:return["uYTex","uUTex","uVTex"].map(function(e){return{name:e,format:"LUMINANCE"}});case E:case y:return[{name:"uYTex",format:"LUMINANCE"},{name:"uCTex",format:"LUMINANCE_ALPHA"}]}}(e);this.samplers=n.map(function(e,n){return r=t.gl,i=t.program,a=e.name,o=e.format,u=n,t.cameraPosition,t.texture,s=r.createTexture(),c=r.getUniformLocation(i,a),r.activeTexture(r.TEXTURE0+u),r.bindTexture(r.TEXTURE_2D,s),function(e){r.activeTexture(r.TEXTURE0+u),r.bindTexture(r.TEXTURE_2D,s),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,!1),r.texImage2D(r.TEXTURE_2D,0,r[o],e.width,e.height,0,r[o],r.UNSIGNED_BYTE,e.data),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.uniform1i(c,u)};var r,i,a,o,u,s,c})}},{key:"setupUniforms",value:function(){var e=this;[{name:"uFilterRegionTransform",value:v().translate(this.texCoordTranslate[0],this.texCoordTranslate[1]).scale(this.texCoord[0],this.texCoord[1])},{name:"uTexCoordTransform",value:v().scale(1,1).rotate(Math.PI*this.orientation/180)}].forEach(function(t){var n,r,i,a;(n=e.gl,r=e.program,i=t.name,a=n.getUniformLocation(r,i),function(e){n.uniformMatrix3fv(a,!1,e)})(t.value)})}},{key:"setupAttributes",value:function(){var e=this;[{name:"aQuad",value:new Float32Array([-1,-1,1,-1,-1,1,1,1])}].forEach(function(t){var n,r,i,a,o;(n=e.gl,r=e.program,i=t.name,a=n.createBuffer(),o=n.getAttribLocation(r,i),n.enableVertexAttribArray(o),function(e){n.bindBuffer(n.ARRAY_BUFFER,a),n.bufferData(n.ARRAY_BUFFER,e,n.STATIC_DRAW),n.vertexAttribPointer(o,2,n.FLOAT,!1,0,0)})(t.value)})}},{key:"resize",value:function(){var e=this.gl,t=e.getParameter(e.VIEWPORT);e.viewport(t[0],t[1],t[2],t[3])}},{key:"setupCameraSize",value:function(e,t){var n=t,r=e,i=n/r,a=t/e;if("STRETCH"===this.cameraSize||i===a)return[1,1];if("CONTAIN"===this.cameraSize){var o=[];if(i<a){var u=n*e/t/r;o=[1,u],this.texCoordTranslate=[0,1-u]}else{var s=t/e*r/n;o=[s,1],this.texCoordTranslate=[s-1,0]}return o}return i<a?[t/e*r/n,1]:[1,n*e/t/r]}},{key:"update",value:function(e){var t=this;if(e){if(0===this.samplers.length)return this.texCoord=this.setupCameraSize(e.width,e.height),this.setupSamplers(e.format),this.setupUniforms(),this.setupAttributes(),void this.resize();var n=this.gl,r=[];r=function(e){switch(e.format){case T:case g:break;case p:return["uYTex","uUTex","uVTex"].map(function(e){return{name:e,format:"LUMINANCE"}});case R:return[{data:A(e.dataArray[0]),width:e.width,height:e.height},{data:A(e.dataArray[1]),width:e.width/2,height:e.height/2},{data:A(e.dataArray[2]),width:e.width/2,height:e.height/2}];case E:case y:return[{data:e.dataArray[0],width:e.width,height:e.height},{data:e.dataArray[1],width:e.width/2,height:e.height/2}]}}(e),this.samplers.forEach(function(e,t){return e(r[t])}),this.plugins.forEach(function(e){return e(t)}),n.drawArrays(n.TRIANGLE_STRIP,0,4)}}},{key:"applyPlugin",value:function(e){"function"==typeof e&&this.plugins.push(e)}}]),e}();function C(e,t,n){var r=e.createShader(t);if(e.shaderSource(r,n),e.compileShader(r),e.getShaderParameter(r,e.COMPILE_STATUS))return r;var i=e.getShaderInfoLog(r);throw e.deleteShader(r),new Error(i)}var k,I="vTexCoord",F=(x(k={},"I420","\n    precision mediump float;\n\n    varying vec2 "+I+";\n\n    uniform sampler2D uYTex;\n    uniform sampler2D uUTex;\n    uniform sampler2D uVTex;\n\n    const mat3 mYUV2RGB = mat3(1.,1.,1.,0.,-0.39173,2.017,1.5985,-0.8129,0.);\n\n    void main(){\n      float y = 1.1643*(texture2D(uYTex,"+I+").r - 0.0625);\n      float u = texture2D(uUTex,"+I+").r - 0.5;\n      float v = texture2D(uVTex,"+I+").r - 0.5;\n      \n      gl_FragColor = vec4(mYUV2RGB * vec3(y,u,v),1.0);\n    }"),x(k,"420v","\n    precision mediump float;\n\n    uniform sampler2D uYTex;\n\n    uniform sampler2D uCTex;\n\n    varying vec2 "+I+";\n\n    const mat3 transformYCrCbITURec601FullRangeToRGB = mat3(1.,1.,1.,0., -.18732, 1.8556,1.57481, -.46813,0.);\n\n    void main(){\n      vec3 colourYCrCb;\n      colourYCrCb.x  = texture2D(uYTex, "+I+").r;\n      colourYCrCb.yz = texture2D(uCTex, "+I+").ra - 0.5;\n      gl_FragColor = vec4(transformYCrCbITURec601FullRangeToRGB * colourYCrCb, 1.0);\n    }"),k),U={fshader:l?F.I420:F["420v"],vshader:"\n  precision mediump float;\n\n  attribute vec2 aQuad;\n  varying vec2 vTexCoord;\n  uniform bool uFlipXCoord;\n  uniform mat3 uFilterRegionTransform;\n  uniform mat3 uTexCoordTransform;\n\n  void main(){\n    vec3 point = vec3(aQuad,1.0);\n    vec3 texCoord = uTexCoordTransform * point;\n    vTexCoord = texCoord.xy / 2. + .5;\n    vec3 pos = uFilterRegionTransform * point;\n    gl_Position = vec4(pos.xy,0.0,1.0);\n  }"},P=function(){function e(t){S(this,e);var n=t.gl,r=t.ARSession,i=t.cameraPosition,a=t.cameraSize,o=t.orientation;this.gl=n,this.ARSession=r,this.fb=null,this.texture=n.createTexture(),this.renderer=new D(n,U,{cameraPosition:i,cameraSize:a,orientation:o}),this.isInitFramebuffer=!1}return w(e,[{key:"update",value:function(){this.isInitFramebuffer||(this.initFramebuffer(),this.isInitFramebuffer=!0),this.render()}},{key:"draw",value:function(){this.isInitFramebuffer&&(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.isInitFramebuffer=!1),this.render()}},{key:"render",value:function(){this.isDirty&&this.isRunning&&this.renderer.update(this.getFrames())}},{key:"dispose",value:function(){this.fbo=null}},{key:"getFrames",value:function(){return this.ARSession.getCurrentFrame()}},{key:"initFramebuffer",value:function(){var e,t=this.gl,n=t.createFramebuffer();this.fb=n,t.bindFramebuffer(t.FRAMEBUFFER,n),e=t.createTexture(),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,e),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,e,0),t.texImage2D(t.TEXTURE_2D,0,t.RGB,480,640,0,t.RGB,t.UNSIGNED_BYTE,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR)}},{key:"isRunning",get:function(){return this.ARSession.isRunning}},{key:"isDirty",get:function(){return this.ARSession.isDirty}}]),e}();function O(e){if(!e)return"";var t="";switch(e.split(",")[1].trim()){case"facing back":t=r;break;case"facing front":t=n}return t}var M=function(){function t(n,r){var i=this;S(this,t),this.ARSession=window.ARSession||window.ucweb.ARSession,this.name=n,this._option=r||{},this.ARSession.addEventListener(e,function(e){if(e&&i._onDetected){var t=JSON.parse(e);i._onDetected(i._resultFilter?i._resultFilter(t):t)}})}return w(t,[{key:"removeMarkers",value:function(){this._ucDetector.removeMarkers()}},{key:"start",value:function(){var e=this;return new Promise(function(t,n){e.ARSession.addEventListener("DetectorInitResult",function(e){h&&t(e),0===e||101===e?t(e):n(e)}),e._ucDetector=e.ARSession.setDetector(e.name),e.setMarkers&&e.setMarkers(e._option)}).then(function(e){return e})}},{key:"pause",value:function(){this._ucDetector.pause()}},{key:"resume",value:function(){this._ucDetector.resume()}},{key:"dispose",value:function(){}},{key:"onResult",value:function(e){this._onDetected=e}}]),t}(),N=["rect","confidence","alignment","pose","direction"];function L(e,t){var n=Object.assign({},e);return n.x=t.width-e.x,e.width&&(n.x-=e.width),n}var X=function(e){function t(e){S(this,t);var n=b(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,o,e));return n.resolution=e.resolution,n.defaultOption={mode:0,singleFace:!1,turbo:!1,dThreshold:{up:.32,right:.35,down:.5,left:.65},speed:4,minSize:40},n}return _(t,M),w(t,[{key:"_resultFilter",value:function(e){var t=this;return e.alignment&&e.alignment.length>0&&(e.alignment=e.alignment.map(function(e){return e.map(function(e){return L(e,t.resolution)})})),e.rect&&e.rect.length>0&&(e.rect=e.rect.map(function(e){return L(e,t.resolution)})),e}},{key:"setMarkers",value:function(e){this._onDetected=this._option.onDetected;var t,n,r,i,a,o,u=[(t=this.defaultOption,n=e,r=n.speed,i=n.singleFace,a=n.turbo,o=0,N.forEach(function(e,t){N.indexOf(e)>=0&&n[e]&&(o+=Math.pow(2,t))}),JSON.stringify(Object.assign(t,{speed:r,singleFace:i,turbo:a,mode:o})))];this._ucDetector.setOption(u),this._ucDetector.setOptions?this._ucDetector.setOptions(u):this._ucDetector.setMarkers(u),this._ucDetector.resume()}},{key:"setOption",value:function(e){this.setMarkers(e)}}]),t}(),Y=function(e){function t(e){return S(this,t),b(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,u,e))}return _(t,M),w(t,[{key:"setMarkers",value:function(e){this._onDetected=this._option.onDetected,this._ucDetector.setMarkers([e.option.url]),this._ucDetector.resume()}}]),t}(),B={},z=null;var G=function(){function e(t,n){S(this,e);var o=n.facing,u=void 0===o?r:o,h=n.quality,m=void 0===h?i:h,d=n.cameraSize,v=void 0===d?a:d,T=n.orientation;this.ARSession=t,this.cameraPosition=u,this.quality=function(e){switch(e){case f:return{quality:f,width:1080,height:1920};case c:return{quality:c,width:720,height:1280};default:return{quality:s,width:480,height:640}}}(m),this.cameraSize=v,this.orientation=T&&l?-90:90,this.frameSize=null}return w(e,[{key:"isRunning",value:function(){return this.ARSession.isRunning()}},{key:"frameSize",value:function(){}},{key:"openAsync",value:function(){var e=this;return new Promise(function(t,r){var i,a;H(e.ARSession,"SessionFail",r),H(e.ARSession,"SessionStart",t),(i=e.cameraPosition,a=e.quality,new Promise(function(e){if(h)return e({cameraPosition:i,quality:a.quality});var t=a.width,r=a.height,o=i===n?"user":"environment";window.ARSession&&window.ARSession.version?navigator.mediaDevices.enumerateDevices().then(function(n){for(var a=!1,o=void 0,u=0;u!==n.length;++u){var s=n[u];"videoinput"===s.kind&&O(s.label)===i&&(o={video:{deviceId:{exact:s.deviceId},minWidth:r,maxWidth:r,minHeight:t,maxHeight:t}},a=!0)}a||(o={video:!0}),e(o)}).catch(function(e){console.warn(e)}):window.ucweb.ARSession&&MediaStreamTrack.getSources(function(n){for(var i=void 0,a=!1,u=0;u!==n.length;++u){var s=n[u];"video"===s.kind&&s.facing===o&&(i={video:{mandatory:{sourceId:s.id,minWidth:r,maxWidth:r,minHeight:t,maxHeight:t}}},a=!0)}a||(i={video:!0}),e(i)})})).then(function(t){return e.ARSession.start(t)})}).then(function(e){return e},function(e){return e})}},{key:"closeAsync",value:function(){var e=this;return new Promise(function(t,n){H(e.ARSession,"SessionStop",n),e.ARSession.stop()}).then()}},{key:"createDisplayTarget",value:function(e){var t={gl:e,ARSession:this.ARSession,cameraPosition:this.cameraPosition,cameraSize:this.cameraSize,orientation:this.orientation};return new P(t)}},{key:"pause",value:function(){this.ARSession.pause()}},{key:"resume",value:function(){this.ARSession.resume()}},{key:"prepareForDetector",value:function(){}},{key:"setDetector",value:function(e,t){return function(e,t){if(z&&z.setMarkers(t),!B[e])return B[e]=function(){switch(e){case o:z=new X(t);break;case u:z=new Y(t)}if(z)return z}(),B[e]}(e,Object.assign(t,{resolution:this.quality}))}},{key:"getFrame",value:function(){return[].slice.call(this.ARSession.getCurrentFrames())}}],[{key:"getAvaiableDetectorNames",value:function(){return B[e];var e}},{key:"CAMERA_POSITION",get:function(){return{FRONT:n,BACK:r}}},{key:"QUALITY",get:function(){return{LOW:i,MEDIUM:"MEDIUM",HIGH:"HIGH"}}},{key:"DETECTOR",get:function(){return{FACE:o,MARKER:u}}},{key:"CAMERA_SIZE",get:function(){return{COVER:a,STRETCH:"STRETCH",CONTAIN:"CONTAIN"}}}]),e}();function H(e,t,n){e.addEventListener(t,function(){setTimeout(function(){return e.removeEventListener(t,n)},0),n.apply(void 0,arguments)})}return function(){function e(){S(this,e)}return w(e,null,[{key:"getWebCameraAsync",value:function(e){return new Promise(function(n,r){new Promise(function(e,n){var r=null,i=setTimeout(function(){n(),clearInterval(r)},5e3);if(window.ARSession)return clearTimeout(i),void e(window.ARSession);r=setInterval(function(){if(window.ARSession)return clearInterval(r),clearTimeout(i),void e(window.ucweb.ARSession)},20),window.addEventListener(t,function(){clearInterval(r),clearTimeout(i),e(window.ARSession)})}).then(function(t){n(new G(t,e))},function(e){r(e)})})}},{key:"getWebMicroPhoneAsync",value:function(){}}]),e}()});
