!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.WebAR=t()}(this,function(){"use strict";var e="DetectorResult",t="ARSessionDidInit";var n="FRONT",r="BACK",i="LOW",a="COVER",o="STRETCH",s="FaceDetector",u="MarkerDetector",c="LOW",h="MEDIUM",f="HIGH";var l=/\(i[^;]+;( U;)? CPU.+Mac OS X/.test(navigator.userAgent),m=!l;function v(e){return e&&m?-90:90}var d=void 0;function g(){this.elements=[1,0,0,0,1,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix3: the constructor no longer reads arguments. use .set() instead.")}Object.assign(g.prototype,{isMatrix3:!0,set:function(e,t,n,r,i,a,o,s,u){var c=d.elements;return c[0]=e,c[1]=r,c[2]=o,c[3]=t,c[4]=i,c[5]=s,c[6]=n,c[7]=a,c[8]=u,d},identity:function(){return d.set(1,0,0,0,1,0,0,0,1),d},clone:function(){return(new d.constructor).fromArray(d.elements)},copy:function(e){var t=d.elements,n=e.elements;return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],d},setFromMatrix4:function(e){var t=e.elements;return d.set(t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]),d},multiply:function(e){return this.multiplyMatrices(this,e)},premultiply:function(e){return this.multiplyMatrices(e,this)},multiplyMatrices:function(e,t){var n=e.elements,r=t.elements,i=this.elements,a=n[0],o=n[3],s=n[6],u=n[1],c=n[4],h=n[7],f=n[2],l=n[5],m=n[8],v=r[0],d=r[3],g=r[6],p=r[1],y=r[4],T=r[7],A=r[2],w=r[5],R=r[8];return i[0]=a*v+o*p+s*A,i[3]=a*d+o*y+s*w,i[6]=a*g+o*T+s*R,i[1]=u*v+c*p+h*A,i[4]=u*d+c*y+h*w,i[7]=u*g+c*T+h*R,i[2]=f*v+l*p+m*A,i[5]=f*d+l*y+m*w,i[8]=f*g+l*T+m*R,this},multiplyScalar:function(e){var t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this},determinant:function(){var e=this.elements,t=e[0],n=e[1],r=e[2],i=e[3],a=e[4],o=e[5],s=e[6],u=e[7],c=e[8];return t*a*c-t*o*u-n*i*c+n*o*s+r*i*u-r*a*s},getInverse:function(e,t){e&&e.isMatrix4&&console.error("THREE.Matrix3: .getInverse() no longer takes a Matrix4 argument.");var n=e.elements,r=this.elements,i=n[0],a=n[1],o=n[2],s=n[3],u=n[4],c=n[5],h=n[6],f=n[7],l=n[8],m=l*u-c*f,v=c*h-l*s,d=f*s-u*h,g=i*m+a*v+o*d;if(0===g){var p="THREE.Matrix3: .getInverse() can't invert matrix, determinant is 0";if(!0===t)throw new Error(p);return console.warn(p),this.identity()}var y=1/g;return r[0]=m*y,r[1]=(o*f-l*a)*y,r[2]=(c*a-o*u)*y,r[3]=v*y,r[4]=(l*i-o*h)*y,r[5]=(o*s-c*i)*y,r[6]=d*y,r[7]=(a*h-f*i)*y,r[8]=(u*i-a*s)*y,this},transpose:function(){var e=void 0,t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this},getNormalMatrix:function(e){return this.setFromMatrix4(e).getInverse(this).transpose()},transposeIntoArray:function(e){var t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this},setUvTransform:function(e,t,n,r,i,a,o){var s=Math.cos(i),u=Math.sin(i);this.set(n*s,n*u,-n*(s*a+u*o)+a+e,-r*u,r*s,-r*(-u*a+s*o)+o+t,0,0,1)},scale:function(e,t){var n=this.elements;return n[0]*=e,n[3]*=e,n[6]*=e,n[1]*=t,n[4]*=t,n[7]*=t,this},rotate:function(e){var t=Math.cos(e),n=Math.sin(e),r=this.elements,i=r[0],a=r[3],o=r[6],s=r[1],u=r[4],c=r[7];return r[0]=t*i+n*s,r[3]=t*a+n*u,r[6]=t*o+n*c,r[1]=-n*i+t*s,r[4]=-n*a+t*u,r[7]=-n*o+t*c,this},translate:function(e,t){var n=this.elements;return n[0]+=e*n[2],n[3]+=e*n[5],n[6]+=e*n[8],n[1]+=t*n[2],n[4]+=t*n[5],n[7]+=t*n[8],this},equals:function(e){for(var t=this.elements,n=e.elements,r=0;r<9;r++)if(t[r]!==n[r])return!1;return!0},fromArray:function(e,t){void 0===t&&(t=0);for(var n=0;n<9;n++)this.elements[n]=e[n+t];return this},toArray:function(e,t){void 0===e&&(e=[]),void 0===t&&(t=0);var n=this.elements;return e[t]=n[0],e[t+1]=n[1],e[t+2]=n[2],e[t+3]=n[3],e[t+4]=n[4],e[t+5]=n[5],e[t+6]=n[6],e[t+7]=n[7],e[t+8]=n[8],e}});var p=0,y=1,T=2,A=3,w=4,R=5;function E(e){return e instanceof ArrayBuffer?new Uint8Array(e):e}var x=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},S=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),_=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e},k=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},b=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},D=function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)},P=function(){function e(t,n,r){var i=r.cameraPosition,a=r.cameraSize,o=r.orientation,s=r.stPosition,u=r.stMatrix;x(this,e),this.gl=t,this.canvas=t.canvas,this.orientation=l?o:-o,this.stPosition=s,this.stMatrix=u,this.cameraPosition=i,this.cameraSize=a,this.stPosition=s,this.vertexShader=C(t,t.VERTEX_SHADER,n.vshader),this.fragmentShader=C(t,t.FRAGMENT_SHADER,n.fshader),this.program=function(e,t,n){var r=e.createProgram();if(e.attachShader(r,t),e.attachShader(r,n),e.linkProgram(r),e.getProgramParameter(r,e.LINK_STATUS))return r;var i=e.getProgramInfoLog(r);throw e.deleteProgram(r),new Error(i)}(t,this.vertexShader,this.fragmentShader),this.samplers=[],this.plugins=[],this.UVArea={width:0,height:0},t.useProgram(this.program)}return S(e,[{key:"setupSamplers",value:function(e){var t=this,n=function(e){switch(e){case p:case y:break;case T:return["uYTex","uUTex","uVTex"].map(function(e){return{name:e,format:"LUMINANCE"}});case A:return["uYTex","uUTex","uVTex"].map(function(e){return{name:e,format:"LUMINANCE"}});case w:case R:return[{name:"uYTex",format:"LUMINANCE"},{name:"uCTex",format:"LUMINANCE_ALPHA"}]}}(e);this.samplers=n.map(function(e,n){return r=t.gl,i=t.program,a=e.name,o=e.format,s=n,t.cameraPosition,t.texture,u=r.createTexture(),c=r.getUniformLocation(i,a),r.activeTexture(r.TEXTURE0+s),r.bindTexture(r.TEXTURE_2D,u),function(e){r.activeTexture(r.TEXTURE0+s),r.bindTexture(r.TEXTURE_2D,u),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,!1),r.texImage2D(r.TEXTURE_2D,0,r[o],e.width,e.height,0,r[o],r.UNSIGNED_BYTE,e.data),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.uniform1i(c,s)};var r,i,a,o,s,u,c})}},{key:"setupUniforms",value:function(){var e=this;[{name:"uFilterRegionTransform",value:(new g).elements},{name:"uTexCoordTransform",value:function(e){if(e===n)return(new g).translate(-.5,-.5).rotate(-Math.PI/2).translate(.5,.5).elements;return(new g).translate(-.5,-.5).rotate(-Math.PI/2).scale(1,-1).translate(.5,.5).elements}(this.cameraPosition)}].forEach(function(t){var n,r,i,a;(n=e.gl,r=e.program,i=t.name,a=n.getUniformLocation(r,i),function(e){n.uniformMatrix3fv(a,!1,e)})(t.value)})}},{key:"setupAttributes",value:function(e,t){var n=this,r=[{name:"aQuad",value:new Float32Array(function(e,t,n){var r=t.width,i=t.height;e||(e={x:0,y:0,width:r,height:i});n.width=e.width/r,n.height=e.height/i;var a=[e.x/r*2-1,(i-e.y)/i*2-1],o=[(e.x+e.width)/r*2-1,a[1]],s=[a[0],(i-e.y-e.height)/i*2-1];return new Float32Array([].concat(a,o,s,[o[0],s[1]]))}(this.stPosition,this.canvas,this.UVArea))},{name:"a_TexCoord",value:M(this.cameraSize,t,e,this.UVArea.width*this.canvas.width,this.UVArea.height*this.canvas.height,this.canvas)}];M(t,e,this.UVArea.width*this.canvas.width,this.UVArea.height*this.canvas.height,this.canvas),r.forEach(function(e){var t,r,i,a,o,s=e.value.BYTES_PER_ELEMENT;(t=n.gl,r=n.program,i=e.name,a=t.createBuffer(),o=t.getAttribLocation(r,i),t.enableVertexAttribArray(o),function(e,n){t.bindBuffer(t.ARRAY_BUFFER,a),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),t.vertexAttribPointer(o,2,t.FLOAT,!1,n,0)})(e.value,2*s)})}},{key:"resize",value:function(){var e=this.gl,t=e.getParameter(e.VIEWPORT);e.viewport(t[0],t[1],t[2],t[3])}},{key:"update",value:function(e){var t=this;if(e){if(0===this.samplers.length)return this.setupSamplers(e.format),this.setupUniforms(),this.setupAttributes(e.width,e.height),void this.resize();var n=this.gl,r=[];r=function(e){switch(e.format){case p:case y:break;case T:return["uYTex","uUTex","uVTex"].map(function(e){return{name:e,format:"LUMINANCE"}});case A:return[{data:E(e.dataArray[0]),width:e.width,height:e.height},{data:E(e.dataArray[1]),width:e.width/2,height:e.height/2},{data:E(e.dataArray[2]),width:e.width/2,height:e.height/2}];case w:case R:return[{data:e.dataArray[0],width:e.width,height:e.height},{data:e.dataArray[1],width:e.width/2,height:e.height/2}]}}(e),this.samplers.forEach(function(e,t){return e(r[t])}),this.plugins.forEach(function(e){return e(t)}),n.drawArrays(n.TRIANGLE_STRIP,0,4)}}},{key:"applyPlugin",value:function(e){"function"==typeof e&&this.plugins.push(e)}}]),e}();function M(e,t,n,r,i,a){if(e===o)return new Float32Array([0,1,1,1,0,0,1,0]);var s=0,u=0,c=void 0,h=void 0,f=void 0,l=void 0;return t/n>=r/i?(u=1,h=[(((s=t/n*i/r)-1)/2+1)/s,1],f=[(c=[(s-1)/2/s,1])[0],0],l=[h[0],0]):(s=1,h=[1,(c=[0,(((u=n/t*r/i)-1)/2+1)/u])[1]],l=[1,(f=[0,(u-1)/2/u])[1]],console.log(c,h,f,l)),new Float32Array([].concat(D(c),D(h),D(f),D(l)))}function C(e,t,n){var r=e.createShader(t);if(e.shaderSource(r,n),e.compileShader(r),e.getShaderParameter(r,e.COMPILE_STATUS))return r;var i=e.getShaderInfoLog(r);throw e.deleteShader(r),new Error(i)}var I,U="vTexCoord",O=(_(I={},"I420","\n    precision mediump float;\n\n    varying vec2 "+U+";\n\n    uniform sampler2D uYTex;\n    uniform sampler2D uUTex;\n    uniform sampler2D uVTex;\n\n    const mat3 mYUV2RGB = mat3(1.,1.,1.,0.,-0.39173,2.017,1.5985,-0.8129,0.);\n\n    void main(){\n      float y = 1.1643*(texture2D(uYTex,"+U+").r - 0.0625);\n      float u = texture2D(uUTex,"+U+").r - 0.5;\n      float v = texture2D(uVTex,"+U+").r - 0.5;\n      \n      gl_FragColor = vec4(mYUV2RGB * vec3(y,u,v),1.0);\n    }"),_(I,"420v","\n    precision mediump float;\n\n    uniform sampler2D uYTex;\n\n    uniform sampler2D uCTex;\n\n    varying vec2 "+U+";\n\n    const mat3 transformYCrCbITURec601FullRangeToRGB = mat3(1.,1.,1.,0., -.18732, 1.8556,1.57481, -.46813,0.);\n\n    void main(){\n      vec3 colourYCrCb;\n      colourYCrCb.x  = texture2D(uYTex, "+U+").r;\n      colourYCrCb.yz = texture2D(uCTex, "+U+").ra - 0.5;\n      gl_FragColor = vec4(transformYCrCbITURec601FullRangeToRGB * colourYCrCb, 1.0);\n    }"),I),F={fshader:m?O.I420:O["420v"],vshader:"\n  precision mediump float;\n\n  attribute vec2 aQuad;\n  attribute vec2 a_TexCoord;\n  varying vec2 vTexCoord;\n  uniform bool uFlipXCoord;\n  uniform mat3 uFilterRegionTransform;\n  uniform mat3 uTexCoordTransform;\n\n  void main(){\n    vec3 point = vec3(aQuad,1.0);\n    vec3 texCoord = point;\n    vec3 tex = vec3(a_TexCoord, 1.0);\n    vec3 tmp = uTexCoordTransform * tex;\n    vTexCoord = tmp.xy;\n    vec3 pos = uFilterRegionTransform * point;\n    gl_Position = vec4(pos.xy,0.0,1.0);\n  }"},L=function(){function e(t,n){x(this,e);var r=n.ARSession,i=n.cameraPosition,a=n.cameraSize,o=n.orientation,s=n.stPosition,u=n.stMatrix;this.gl=t,this.ARSession=r,this.cameraSize=a,this.renderer=new P(t,F,{cameraPosition:i,cameraSize:a,orientation:v(o),stPosition:s,stMatrix:u})}return S(e,[{key:"update",value:function(){this.render()}},{key:"draw",value:function(){this.render()}},{key:"render",value:function(){this.isDirty&&this.isRunning&&this.renderer.update(this.getFrames())}},{key:"dispose",value:function(){}},{key:"getFrames",value:function(){return this.ARSession.getCurrentFrame()}},{key:"getImage",value:function(){}},{key:"isRunning",get:function(){return this.ARSession.isRunning}},{key:"isDirty",get:function(){return this.ARSession.isDirty}}]),e}();function N(e){if(!e)return"";var t="";switch(e.split(",")[1].trim()){case"facing back":t=r;break;case"facing front":t=n}return t}var Y=function(){function t(n,r){var i=this;x(this,t),this.ARSession=window.ARSession||window.ucweb.ARSession,this.name=n,this._option=r||{},this.ARSession.addEventListener(e,function(e){if(e&&i._onDetected){var t=JSON.parse(e);i._onDetected(i._resultFilter?i._resultFilter(t):t)}})}return S(t,[{key:"removeMarkers",value:function(){this._ucDetector.removeMarkers()}},{key:"start",value:function(){var e=this;return new Promise(function(t,n){e.ARSession.addEventListener("DetectorInitResult",function(e){l&&t(e),0===e||101===e?t(e):n(e)}),e._ucDetector=e.ARSession.setDetector(e.name),e.setMarkers&&e.setMarkers(e._option)}).then(function(e){return e})}},{key:"pause",value:function(){this._ucDetector.pause()}},{key:"resume",value:function(){this._ucDetector.resume()}},{key:"dispose",value:function(){}},{key:"onResult",value:function(e){this._onDetected=e}}]),t}(),H=["rect","confidence","alignment","pose","direction"];function V(e,t){var n=Object.assign({},e);return n.x=t.width-e.x,e.width&&(n.x-=e.width),n}var X=function(e){function t(e){x(this,t);var n=b(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,s,e));return n.resolution=e.resolution,n.defaultOption={mode:0,singleFace:!1,turbo:!1,dThreshold:{up:.32,right:.35,down:.5,left:.65},speed:4,minSize:40},n}return k(t,Y),S(t,[{key:"_resultFilter",value:function(e){var t=this;return e.alignment&&e.alignment.length>0&&(e.alignment=e.alignment.map(function(e){return e.map(function(e){return V(e,t.resolution)})})),e.rect&&e.rect.length>0&&(e.rect=e.rect.map(function(e){return V(e,t.resolution)})),e}},{key:"setMarkers",value:function(e){this._onDetected=this._option.onDetected;var t,n,r,i,a,o,s=[(t=this.defaultOption,n=e,r=n.speed,i=n.singleFace,a=n.turbo,o=0,H.forEach(function(e,t){H.indexOf(e)>=0&&n[e]&&(o+=Math.pow(2,t))}),JSON.stringify(Object.assign(t,{speed:r,singleFace:i,turbo:a,mode:o})))];this._ucDetector.setOption(s),this._ucDetector.setOptions?this._ucDetector.setOptions(s):this._ucDetector.setMarkers(s),this._ucDetector.resume()}},{key:"setOption",value:function(e){this.setMarkers(e)}}]),t}(),W=function(e){function t(e){return x(this,t),b(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,u,e))}return k(t,Y),S(t,[{key:"setMarkers",value:function(e){this._onDetected=this._option.onDetected,this._ucDetector.setMarkers([e.option.url]),this._ucDetector.resume()}}]),t}(),j={},z=null;var B=function(){function e(t,n){x(this,e);var o=n.facing,s=void 0===o?r:o,u=n.quality,l=void 0===u?i:u,m=n.cameraSize,d=void 0===m?a:m,g=n.orientation;this.ARSession=t,this.cameraPosition=s,this.quality=function(e){switch(e){case f:return{quality:f,width:1080,height:1920};case h:return{quality:h,width:720,height:1280};default:return{quality:c,width:480,height:640}}}(l),this.cameraSize=d,this.orientation=v(g),this.frameSize=null}return S(e,[{key:"isRunning",value:function(){return this.ARSession.isRunning()}},{key:"frameSize",value:function(){}},{key:"openAsync",value:function(){var e=this;return new Promise(function(t,r){var i,a;G(e.ARSession,"SessionFail",r),G(e.ARSession,"SessionStart",t),(i=e.cameraPosition,a=e.quality,new Promise(function(e){if(l)return e({cameraPosition:i,quality:a.quality});var t=a.width,r=a.height,o=i===n?"user":"environment";window.ARSession&&window.ARSession.version?navigator.mediaDevices.enumerateDevices().then(function(n){for(var a=!1,o=void 0,s=0;s!==n.length;++s){var u=n[s];"videoinput"===u.kind&&N(u.label)===i&&(o={video:{deviceId:{exact:u.deviceId},minWidth:r,maxWidth:r,minHeight:t,maxHeight:t}},a=!0)}a||(o={video:!0}),e(o)}).catch(function(e){console.warn(e)}):window.ucweb.ARSession&&MediaStreamTrack.getSources(function(n){for(var i=void 0,a=!1,s=0;s!==n.length;++s){var u=n[s];"video"===u.kind&&u.facing===o&&(i={video:{mandatory:{sourceId:u.id,minWidth:r,maxWidth:r,minHeight:t,maxHeight:t}}},a=!0)}a||(i={video:!0}),e(i)})})).then(function(t){return e.ARSession.start(t)})}).then(function(e){return e},function(e){return e})}},{key:"closeAsync",value:function(){var e=this;return new Promise(function(t,n){G(e.ARSession,"SessionStop",n),e.ARSession.stop()}).then()}},{key:"createDisplayTarget",value:function(e,t){var n=Object.assign({ARSession:this.ARSession,cameraPosition:this.cameraPosition,orientation:this.orientation},t);return new L(e,n)}},{key:"pause",value:function(){this.ARSession.pause()}},{key:"resume",value:function(){this.ARSession.resume()}},{key:"prepareForDetector",value:function(){}},{key:"setDetector",value:function(e,t){return function(e,t){if(z&&z.setMarkers(t),!j[e])return j[e]=function(){switch(e){case s:z=new X(t);break;case u:z=new W(t)}if(z)return z}(),j[e]}(e,Object.assign(t,{resolution:this.quality}))}},{key:"getFrame",value:function(){return[].slice.call(this.ARSession.getCurrentFrames())}}],[{key:"getAvaiableDetectorNames",value:function(){return j[e];var e}},{key:"CAMERA_POSITION",get:function(){return{FRONT:n,BACK:r}}},{key:"QUALITY",get:function(){return{LOW:i,MEDIUM:"MEDIUM",HIGH:"HIGH"}}},{key:"DETECTOR",get:function(){return{FACE:s,MARKER:u}}},{key:"CAMERA_SIZE",get:function(){return{COVER:a,STRETCH:o,CONTAIN:"CONTAIN"}}}]),e}();function G(e,t,n){e.addEventListener(t,function(){setTimeout(function(){return e.removeEventListener(t,n)},0),n.apply(void 0,arguments)})}return function(){function e(){x(this,e)}return S(e,null,[{key:"getWebCameraAsync",value:function(e){return new Promise(function(n,r){new Promise(function(e,n){var r=null,i=setTimeout(function(){n(),clearInterval(r)},5e3);if(window.ARSession)return clearTimeout(i),void e(window.ARSession);r=setInterval(function(){if(window.ARSession)return clearInterval(r),clearTimeout(i),void e(window.ucweb.ARSession)},20),window.addEventListener(t,function(){clearInterval(r),clearTimeout(i),e(window.ARSession)})}).then(function(t){n(new B(t,e))},function(e){r(e)})})}},{key:"getWebMicroPhoneAsync",value:function(){}}]),e}()});
